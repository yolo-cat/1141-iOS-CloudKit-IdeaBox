```markdown
# 功能規格：SwiftData 與 iCloud 同步整合

**功能分支**: `001-swiftdata-icloud`  
**建立日期**: 2025-11-04  
**狀態**: 草稿  
**輸入**: 使用者描述：「為 app 引入 swiftdata，並且可以同步到 icloud」

> **⚠️ 重要**: 本文件必須使用台灣正體中文撰寫（符合憲法原則 VII）。所有使用者故事、需求、驗收情景均應使用繁體中文，確保團隊對需求的共同理解。

## 使用者情景與測試 *(必填)*

### 使用者故事 1 - 建立 SwiftData 本地持久化 (優先級: P1)

使用者新增、編輯或刪除想法時，這些變更會自動儲存到設備本地儲存空間，即使應用關閉也不會遺失資料。使用者可以在任何時間開啟應用，看到之前建立的所有想法及其最新狀態。

**為何此優先級**: 這是核心功能，無法實現資料持久化將導致應用無法使用。所有其他功能都仰賴此基礎。

**獨立測試**: 不需要 iCloud 或網路連接。可通過 (1) 建立新想法、(2) 重啟應用、(3) 驗證想法仍存在 來完全測試。此故事獨立提供完整的本地持久化 MVP。

**驗收情景**:

1. **假設** 使用者在應用中，當 點選「+」按鈕並建立新想法 (標題「測試想法」、描述「測試描述」)，則 新想法立即出現在列表中，標記為未完成
2. **假設** 使用者剛建立了一個想法，當 完全關閉應用（從背景移除），則 想法資料已儲存到本地設備
3. **假設** 應用已完全關閉且想法已儲存，當 使用者重新開啟應用，則 之前建立的想法出現在列表中，狀態和內容完全相同
4. **假設** 使用者有多個想法已儲存，當 點選想法的核取方塊標記為完成，則 狀態變更立即保存，重啟應用後狀態仍保持
5. **假設** 使用者有想法已儲存，當 對該想法進行左滑並點選刪除，則 想法立即從列表移除且不再出現，即使重啟應用也不會恢復

---

### 使用者故事 2 - 設定 iCloud 同步容器 (優先級: P1)

應用建立時自動初始化 SwiftData 以使用 iCloud 作為儲存後端。應用與 Apple iCloud 服務建立安全連接，使用 CloudKit 框架進行同步。無需使用者手動配置。

**為何此優先級**: iCloud 同步是核心需求的基礎。沒有此設定，無法實現多設備同步功能。

**獨立測試**: 可通過 (1) 確認應用成功初始化 SwiftData 容器、(2) 驗證 CloudKit 同步已啟動、(3) 檢查 iCloud 存取權限 來獨立測試。不需要使用者登入動作即可驗證。

**驗收情景**:

1. **假設** 應用首次啟動且使用者已在設備上登入 iCloud，當 應用初始化，則 SwiftData 自動配置使用預設 iCloud 容器
2. **假設** SwiftData 已配置使用 iCloud，當 應用執行，則 CloudKit 同步引擎在背景啟動且不影響 UI 回應性
3. **假設** 設備上未登入任何 iCloud 帳號，當 應用初始化，則 應用自動降級至本地 SQLite 儲存（無 iCloud 同步），應用仍可正常運作
4. **假設** 應用正在執行且 iCloud 連接中斷（飛航模式、離線），當 使用者建立或編輯想法，則 變更儲存到本地待同步佇列，復連時自動同步

---

### 使用者故事 3 - 多設備想法同步 (優先級: P2)

使用者在一台設備上建立或修改想法時，該變更在短時間內（通常數秒）自動出現在登入相同 iCloud 帳號的其他設備上。所有設備看到一致的想法列表和狀態。

**為何此優先級**: 此功能提供跨設備連續性。建立後續需要多設備無縫同步的進階功能所必需。

**獨立測試**: 可通過 (1) 使用兩台登入相同 iCloud 帳號的設備、(2) 在一台設備上建立/修改想法、(3) 在另一台設備觀察自動出現並保持同步 來獨立驗證。此故事在故事 1 和 2 完成後獨立提供多設備同步 MVP。

**驗收情景**:

1. **假設** 用戶在設備 A 上登入 iCloud 且應用已運行，當 使用者建立新想法「設備間同步測試」，則 30 秒內想法在設備 B 上自動出現（同一 iCloud 帳號）
2. **假設** 想法已在設備 A 和 B 上同步，當 使用者在設備 A 上將想法標記為完成，則 核取方塊狀態在 30 秒內在設備 B 上自動更新
3. **假設** 想法在多設備間同步，當 使用者在設備 A 上編輯想法描述，則 新描述內容在 30 秒內出現在設備 B 上
4. **假設** 使用者在設備 A 上刪除想法，當 刪除操作完成，則 30 秒內想法在設備 B 上自動移除

---

### 邊界情況

- 當使用者同時在多台設備上編輯相同想法時會發生什麼？應如何解決編輯衝突？
- 如果 iCloud 同步因網路中斷而失敗，應用應如何處理本地變更的隊列？
- 當使用者在設備上禁用 iCloud 同步後重新啟用時，應如何處理衝突或遺漏的變更？

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須初始化 SwiftData 以使用本地 SQLite 資料庫儲存想法資料
- **FR-002**: 系統必須在應用啟動時自動建立 SwiftData 容器並配置 iCloud 同步
- **FR-003**: 系統必須在設備上未登入 iCloud 時優雅地降級至本地儲存，應用應照常運作
- **FR-004**: 系統必須將所有想法變更 (建立、編輯、刪除) 自動同步到 iCloud (若已登入)
- **FR-005**: 系統必須透過 CloudKit 框架與 iCloud 進行安全通訊且不洩露敏感資料
- **FR-006**: 系統必須在主執行緒以外進行 iCloud 同步操作，避免 UI 阻塞
- **FR-007**: 系統必須在網路連接中斷時排隊待同步的變更，復連時自動同步
- **FR-008**: 系統必須在設備間同步時保持想法的完整屬性 (ID、標題、描述、完成狀態、時戳)
- **FR-009**: 系統必須在 15 秒內完成相同 iCloud 帳號設備間的想法同步

### 關鍵實體

- **Idea (想法)**: 代表使用者的單個想法記錄。關鍵屬性包括 id (唯一識別符)、title (標題字串)、description (描述文字)、isCompleted (布林值)、createdDate (時間戳)、modifiedDate (時間戳)。在 iCloud 同步時作為最小同步單位。
- **CloudKit Container (iCloud 容器)**: 代表應用在 iCloud 上的資料容器。系統必須建立預設容器以儲存所有想法資料。

## 成功條件 *(必填)*

### 可測量的結果

- **SC-001**: 使用者可在應用首次啟動後立即建立想法，且重啟應用後想法資料仍完整存在
- **SC-002**: 100% 的想法變更 (建立、編輯、刪除) 能無遺漏地同步到 iCloud (當已登入 iCloud 時)
- **SC-003**: 應用在未登入 iCloud 的情況下能正常運作，使用本地儲存，並在登入後自動同步待同步變更
- **SC-004**: 登入相同 iCloud 帳號的兩台設備間想法同步延遲不超過 15 秒
- **SC-005**: 應用主執行緒在同步操作期間保持回應，UI 不出現卡頓 (不超過 16ms 幀時間損失)
- **SC-006**: 在網路中斷期間本地建立/編輯的想法不會遺失，復連時自動同步成功率達 99%
```
